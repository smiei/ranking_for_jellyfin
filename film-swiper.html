<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Film Swipe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body class="accent-person1">
  <div class="app-container">
    <header>
      <div class="tab-bar">
        <a class="tab" href="index.html">Ranking</a>
        <a class="tab active" href="film-swiper.html">Swipe</a>
        <div class="header-actions">
          <button id="toggleThemeBtn" class="theme-toggle" aria-label="Theme wechseln">
            <span class="icon sun">☀</span>
            <span class="icon moon">☾</span>
          </button>
        </div>
      </div>
    </header>

    <main>
      <section class="card">
        <div class="page-subtitle">
          <h2>Swipe</h2>
        </div>
        <div class="swiper-controls">
          <div class="field-group">
            <label for="movieInput">Filme hinzufuegen</label>
            <div class="row">
              <div class="wide-input-wrap">
                <input id="movieInput" class="wide-input" placeholder="Titel eingeben..." autocomplete="off">
                <div id="movieSuggestList" class="suggest-list hidden"></div>
              </div>
              <button id="addMovieBtn" class="btn secondary" type="button">Hinzufuegen</button>
            </div>
            <div id="selectedMovies" class="tag-list"></div>
          </div>
          <div class="field-group">
            <label>Personen (2-5)</label>
            <div class="person-button-group" id="swiperPersonButtons"></div>
          </div>
        </div>

        <div class="swipe-area">
          <button id="swipeNoBtn" class="swipe-btn swipe-btn-left" aria-label="Nein">✕</button>
          <div id="swipeCard" class="swipe-card" role="button" aria-label="Swipe Karte">
            <div class="swipe-card-body">
              <div class="swipe-card-title" id="swipeTitle">Bitte Filme hinzufuegen</div>
              <div class="swipe-card-meta" id="swipeMeta">Ziehe nach links oder rechts</div>
            </div>
          </div>
          <button id="swipeYesBtn" class="swipe-btn swipe-btn-right" aria-label="Ja">❤</button>
        </div>
        <p id="swipeStatus" class="status-text"></p>
        <div class="match-list card nested">
          <h3>Matches</h3>
          <ul id="matchList"></ul>
        </div>
      </section>
    </main>
  </div>
  <script>
    // Lightmode toggle
    (() => {
      const body = document.body;
      const btnTheme = document.getElementById('toggleThemeBtn');
      const applyTheme = (mode) => {
        if (mode === 'light') body.classList.add('theme-light');
        else body.classList.remove('theme-light');
        btnTheme?.classList.toggle('active', mode === 'light');
      };
      const stored = localStorage.getItem('theme-mode');
      if (stored) applyTheme(stored);
      btnTheme?.addEventListener('click', () => {
        const nowLight = !body.classList.contains('theme-light');
        applyTheme(nowLight ? 'light' : 'dark');
        localStorage.setItem('theme-mode', nowLight ? 'light' : 'dark');
      });
    })();
  </script>
  <script>
    (() => {
      const card = document.getElementById('swipeCard');
      const status = document.getElementById('swipeStatus');
      const btnYes = document.getElementById('swipeYesBtn');
      const btnNo = document.getElementById('swipeNoBtn');
      const movieInput = document.getElementById('movieInput');
      const movieSuggestList = document.getElementById('movieSuggestList');
      const addMovieBtn = document.getElementById('addMovieBtn');
      const selectedMoviesEl = document.getElementById('selectedMovies');
      const personButtonsEl = document.getElementById('swiperPersonButtons');
      const swipeTitle = document.getElementById('swipeTitle');
      const swipeMeta = document.getElementById('swipeMeta');
      const matchList = document.getElementById('matchList');
      const API_BASE = 'http://localhost:5000';
      let suggestions = [];
      let suggestionsMap = {};
      let selectedMovies = [];
      let likes = {};
      let matches = new Set();
      let personCount = 2;
      let persons = [];
      let currentPerson = 'p1';
      let currentIndex = 0;

      if (!card) return;
      let startX = 0;
      let currentX = 0;
      let dragging = false;
      const threshold = 90;

      const setCardTransform = (x) => {
        card.style.transform = `translateX(${x}px) rotate(${x * 0.05}deg)`;
        const opacity = Math.min(Math.abs(x) / threshold, 1);
        card.style.boxShadow = `0 20px 40px rgba(0,0,0,0.35), 0 0 0 1px rgba(255,255,255,0.05), 0 0 0 2px rgba(255,255,255,${opacity * 0.05})`;
      };

      const handleStart = (clientX) => {
        dragging = true;
        startX = clientX;
        card.classList.add('dragging');
        hideButtons();
      };

      const handleMove = (clientX) => {
        if (!dragging) return;
        currentX = clientX - startX;
        setCardTransform(currentX);
      };

      const resetCard = () => {
        dragging = false;
        currentX = 0;
        card.classList.remove('dragging');
        card.style.transform = '';
        card.style.boxShadow = '';
        showButtons();
      };

      function decide(decision) {
        if (!selectedMovies.length) {
          status.textContent = 'Bitte zuerst Filme hinzufuegen.';
          resetCard();
          return;
        }
        const movie = selectedMovies[currentIndex % selectedMovies.length];
        if (decision === 'Ja') recordLike(movie.title, currentPerson);
        else recordDislike(movie.title, currentPerson);
        updateCard();
        status.textContent = `Entscheidung: ${decision}`;
        card.classList.add(decision === 'Ja' ? 'swipe-yes' : 'swipe-no');
        card.style.transform = `translateX(${decision === 'Ja' ? 300 : -300}px) rotate(${decision === 'Ja' ? 12 : -12}deg)`;
        hideButtons();
        setTimeout(() => {
          card.classList.remove('swipe-yes', 'swipe-no');
          resetCard();
          nextMovie();
        }, 250);
      }

      const handleEnd = () => {
        if (!dragging) return;
        const decision = currentX > threshold ? 'Ja' : currentX < -threshold ? 'Nein' : null;
        if (decision) {
          decide(decision);
        } else {
          status.textContent = '';
          resetCard();
        }
      };

      card.addEventListener('pointerdown', (e) => {
        e.preventDefault();
        handleStart(e.clientX);
      });
      window.addEventListener('pointermove', (e) => {
        if (!dragging) return;
        e.preventDefault();
        handleMove(e.clientX);
      });
      window.addEventListener('pointerup', () => handleEnd());
      window.addEventListener('pointercancel', () => handleEnd());

      // Touch fallback
      card.addEventListener('touchstart', (e) => handleStart(e.touches[0].clientX), { passive: true });
      card.addEventListener('touchmove', (e) => handleMove(e.touches[0].clientX), { passive: true });
      card.addEventListener('touchend', handleEnd);
      card.addEventListener('touchcancel', handleEnd);

      const hideButtons = () => {
        btnYes?.classList.add('hidden');
        btnNo?.classList.add('hidden');
      };
      const showButtons = () => {
        btnYes?.classList.remove('hidden');
        btnNo?.classList.remove('hidden');
      };
      btnYes?.addEventListener('click', () => decide('Ja'));
      btnNo?.addEventListener('click', () => decide('Nein'));

      function setPersons(n) {
        personCount = Math.max(2, Math.min(5, n));
        persons = Array.from({ length: personCount }, (_, i) => `p${i + 1}`);
        currentPerson = persons[0];
        renderPersonButtons();
      }

      function renderPersonButtons() {
        if (!personButtonsEl) return;
        personButtonsEl.innerHTML = '';
        persons.forEach((p, idx) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'person-btn' + (p === currentPerson ? ' active' : '');
          btn.textContent = `Person ${idx + 1}`;
          btn.addEventListener('click', () => {
            currentPerson = p;
            renderPersonButtons();
          });
          personButtonsEl.appendChild(btn);
        });
      }

      function updateCard() {
        if (!selectedMovies.length) {
          swipeTitle.textContent = 'Bitte Filme hinzufuegen';
          swipeMeta.textContent = 'Ziehe nach links oder rechts';
          card.classList.remove('has-image');
          card.style.backgroundImage = '';
          return;
        }
        const movie = selectedMovies[currentIndex % selectedMovies.length];
        swipeTitle.textContent = movie.display || movie.title;
        swipeMeta.textContent = '';
        if (movie.image) {
          card.classList.add('has-image');
          card.style.backgroundImage = `linear-gradient(180deg, rgba(0,0,0,0.15), rgba(0,0,0,0.45)), url('${movie.image}')`;
        } else {
          card.classList.remove('has-image');
          card.style.backgroundImage = '';
        }
      }

      function addMovie(displayTitle) {
        if (!displayTitle) return;
        const info = suggestionsMap[displayTitle] || { title: displayTitle };
        if (selectedMovies.find(m => m.title === info.title)) return;
        const movieObj = { title: info.title, display: info.display || displayTitle, image: info.image || '' };
        selectedMovies.push(movieObj);
        likes[info.title] = likes[info.title] || [];
        renderSelectedMovies();
        updateCard();
      }

      function removeMovie(title) {
        selectedMovies = selectedMovies.filter(t => t.title !== title);
        delete likes[title];
        matches.delete(title);
        renderSelectedMovies();
        updateMatches();
        if (currentIndex >= selectedMovies.length) currentIndex = 0;
        updateCard();
      }

      function renderSelectedMovies() {
        if (!selectedMoviesEl) return;
        selectedMoviesEl.innerHTML = '';
        selectedMovies.forEach(m => {
          const tag = document.createElement('div');
          tag.className = 'tag';
          tag.textContent = m.display || m.title;
          const x = document.createElement('span');
          x.className = 'tag-close';
          x.textContent = '✕';
          x.addEventListener('click', () => removeMovie(m.title));
          tag.appendChild(x);
          selectedMoviesEl.appendChild(tag);
        });
      }

      function renderSuggestList(query = '') {
        if (!movieSuggestList) return;
        const q = (query || '').toLowerCase();
        const filtered = suggestions.filter(s => (s.display || s.title || '').toLowerCase().includes(q)).slice(0, 12);
        movieSuggestList.innerHTML = '';
        if (!filtered.length) { movieSuggestList.classList.add('hidden'); return; }
        filtered.forEach(s => {
          const itemEl = document.createElement('div');
          itemEl.className = 'suggest-item';
          itemEl.textContent = s.display || s.title;
          itemEl.addEventListener('click', () => {
            addMovie(s.display || s.title);
            movieSuggestList.classList.add('hidden');
            movieInput.value = '';
          });
          movieSuggestList.appendChild(itemEl);
        });
        movieSuggestList.classList.remove('hidden');
      }

      async function loadSuggestions() {
        try {
          const resp = await fetch(`${API_BASE}/movies`);
          const data = await resp.json();
          if (resp.ok && data.ok) {
            const items = data.items || [];
            suggestionsMap = {};
            suggestions = items.map(i => {
              const display = i.year ? `${i.title} (${i.year})` : i.title;
              const obj = { display, title: i.title, image: i.image };
              suggestionsMap[display] = obj;
              return obj;
            });
          }
        } catch (e) {
          console.error(e);
        }
      }

      function addFromInput() {
        const val = (movieInput?.value || '').trim();
        if (!val) return;
        addMovie(val);
        movieInput.value = '';
        movieSuggestList?.classList.add('hidden');
      }

      addMovieBtn?.addEventListener('click', addFromInput);
      movieInput?.addEventListener('input', () => renderSuggestList(movieInput.value));
      movieInput?.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addFromInput(); } });
      document.addEventListener('click', (e) => {
        if (!movieSuggestList) return;
        if (!movieSuggestList.contains(e.target) && e.target !== movieInput) movieSuggestList.classList.add('hidden');
      });

      function updateMatches() {
        if (!matchList) return;
        matchList.innerHTML = '';
        Array.from(matches).forEach(title => {
          const li = document.createElement('li');
          li.textContent = title;
          matchList.appendChild(li);
        });
      }

      function recordLike(movie, person) {
        if (!likes[movie]) likes[movie] = [];
        if (!likes[movie].includes(person)) likes[movie].push(person);
        if (likes[movie].length >= personCount) {
          matches.add(movie);
          updateMatches();
        }
      }

      function recordDislike(movie, person) {
        if (!likes[movie]) return;
        likes[movie] = likes[movie].filter(p => p !== person);
      }

      function nextMovie() {
        if (!selectedMovies.length) return;
        currentIndex = (currentIndex + 1) % selectedMovies.length;
        updateCard();
      }

      // Override decide to include movie logic
      // init
      setPersons(2);
      loadSuggestions();
      updateCard();
    })();
  </script>
</body>
</html>
